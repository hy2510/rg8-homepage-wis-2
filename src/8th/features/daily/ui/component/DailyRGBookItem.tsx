import { Assets } from '@/8th/assets/asset-library'
import {
  useIsPhone,
  useIsTabletLarge,
} from '@/8th/shared/context/ScreenModeContext'
import { DailyRGBookItemStyle } from '@/8th/shared/styled/FeaturesStyled'
import { ResourceDownloadButtonStyle } from '@/8th/shared/styled/SharedStyled'
import { StartButton } from '@/8th/shared/ui/Buttons'
import DropdownMenu from '@/8th/shared/ui/Dropdowns'
import NumberUtils from '@/util/number-utils'
import Image from 'next/image'

/**
 * Book Single Item
 */

interface DailyRGBookItemProps {
  ref?: React.RefObject<HTMLDivElement | null>
  no: number
  title: string
  imgUrl: string
  passCount: number
  point: number
  color: string
  isCurrent?: boolean
  isPreK?: boolean
  expendMenu?: {
    text: string
    subText?: string
    onClick?: () => void
  }[]
  onExpendMenuClick?: (isOpen: boolean) => void
  onStart?: () => void
  onImageLoaded?: (isSuccess: boolean) => void
}

export default function DailyRGBookItem({
  ref,
  no,
  title,
  imgUrl,
  passCount,
  point,
  color,
  isCurrent,
  isPreK,
  expendMenu,
  onStart,
  onExpendMenuClick,
  onImageLoaded,
}: DailyRGBookItemProps) {
  const isPhone = useIsPhone()

  const isCompleted = point <= 0
  let pointText = `${NumberUtils.toDecimalPoint(point)}P`
  if (isCompleted) {
    pointText = 'Good Job ðŸ‘'
  }

  const onImageLoadEvent = onImageLoaded
    ? () => {
        onImageLoaded(true)
      }
    : undefined
  const onImageErrorEvent = onImageLoaded
    ? () => {
        onImageLoaded(false)
      }
    : undefined

  return (
    <DailyRGBookItemStyle
      ref={ref}
      className={isCurrent ? 'current-book' : ''}
      isPreK={isPreK}
      isCurrent={isCurrent}
      isCompleted={passCount > 0}
      color={color}>
      <div
        className={`book-container ${
          isPreK ? 'mobile-prek-container' : 'mobile-book-container'
        }`}>
        {passCount === 0 && <div className="book-number">{no}</div>}
        {passCount === 1 && <div className="completed-mark" />}
        {passCount >= 2 && <div className="completed-mark-twin" />}
        <div className={isPreK ? 'prek-thumbnail' : 'book-cover'}>
          <Image
            src={imgUrl}
            alt="thumbnail"
            width={100}
            height={100}
            onLoad={onImageLoadEvent}
            onError={onImageErrorEvent}
          />
        </div>
        <div className="title-container">
          <div className="title-box">
            <div className="title">{title}</div>
            {/* <span className="dot">â€¢</span> */}
            <div className={`point ${isCompleted ? 'good-job' : ''}`}>
              {pointText}
            </div>
          </div>
          <div>
            {isPhone ? (
              <ResourceDownloadButton
                isMobile
                expendMenu={expendMenu}
                onExpendMenuClick={onExpendMenuClick}
              />
            ) : (
              <>
                {isCurrent && (
                  <StartButton onClick={onStart} className="animated" />
                )}
              </>
            )}
          </div>
        </div>
      </div>
      {isPhone ? (
        <div style={{ width: '100%' }}>
          {isCurrent && (
            <StartButton
              onClick={onStart}
              isMobile
              className="mobile-animated"
            />
          )}
        </div>
      ) : (
        <div>
          <ResourceDownloadButton
            expendMenu={expendMenu}
            onExpendMenuClick={onExpendMenuClick}
          />
        </div>
      )}
    </DailyRGBookItemStyle>
  )
}

function ResourceDownloadButton({
  isMobile,
  expendMenu,
  onExpendMenuClick,
}: {
  isMobile?: boolean
  expendMenu?: {
    text: string
    subText?: string
    onClick?: () => void
  }[]
  onExpendMenuClick?: (isOpen: boolean) => void
}) {
  const isGnbBottomTablet = useIsTabletLarge('smaller')

  return (
    <ResourceDownloadButtonStyle isMobile={isMobile}>
      <button
        className="download-button-trigger"
        onClick={() => {
          if (onExpendMenuClick) {
            onExpendMenuClick(true)
          }
        }}
        aria-label="Download options">
        <Image
          src={Assets.Icon.moreVerticalGray}
          alt="download"
          width={24}
          height={24}
        />
      </button>
      {expendMenu && expendMenu.length > 0 && (
        <DropdownMenu
          items={expendMenu}
          position={isGnbBottomTablet ? 'leftCenter' : 'rightCenter'}
          isOpen={true}
          onClose={() => {
            if (onExpendMenuClick) {
              onExpendMenuClick(false)
            }
          }}
        />
      )}
    </ResourceDownloadButtonStyle>
  )
}
